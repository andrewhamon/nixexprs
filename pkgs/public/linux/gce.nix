{ linuxBuild, stdenv, linux }: with linuxBuild.config; let
  # https://cloud.google.com/compute/docs/images/building-custom-os
  # TODO: config.system.requiredKernelConfig;
  uncommonConfig = {
    CPU_FREQ_DEFAULT_GOV_PERFORMANCE = no;
    CPU_FREQ_GOV_SCHEDUTIL = no;
    MEMTEST = no;
    CFG80211_WEXT = no;
    IPW2100_MONITOR = no;
    IPW2200_MONITOR = no;
    HOSTAP_FIRMWARE = no;
    HOSTAP_FIRMWARE_NVRAM = no;
    ATH9K_PCI = no;
    ATH9K_AHB = no;
    B43_PHY_HT = no;
    BCMA_HOST_PCI = no;
    FB_NVIDIA_I2C = no;
    DRM_I915_KMS = no;
    DRM_LOAD_EDID_FIRMWARE = no;
    VGA_SWITCHEROO = no;
    DRM_GMA600 = no;
    DRM_GMA3600 = no;
    DRM_AMD_POWERPLAY = no;
    DRM_AMDGPU_SI = no;
    DRM_AMDGPU_CIK = no;
    DRM_I915_GVT = no;
    DRM_I915_GVT_KVMGT = no;
    SND_DYNAMIC_MINORS = no;
    SND_AC97_POWER_SAVE = no;
    SND_HDA_INPUT_BEEP = no;
    SND_HDA_RECONFIG = no;
    SND_HDA_PATCH_LOADER = no;
    SND_OSSEMUL = no;
    SND_USB_CAIAQ_INPUT = no;
    PSS_MIXER = no;
    FS_ENCRYPTION = no;
    EXT4_ENCRYPTION = no;
    XEN_DOM0 = no;
    MEDIA_DIGITAL_TV_SUPPORT = no;
    MEDIA_CAMERA_SUPPORT = no;
    MEDIA_RC_SUPPORT = no;
    MEDIA_CONTROLLER = no;
    MEDIA_PCI_SUPPORT = no;
    MEDIA_USB_SUPPORT = no;
    MEDIA_ANALOG_TV_SUPPORT = no;
    VIDEO_STK1160_COMMON = no;
    VIDEO_STK1160_AC97 = no;
    ZRAM = no;
    #ZSWAP = no;
    ZBUD = no;
    ZSMALLOC = no;
    BRCMFMAC_USB = no;
    BRCMFMAC_PCIE = no;
    NLS_CODEPAGE_437 = yes;
    NLS_ISO8859_1 = yes;
    NLS_UTF8 = yes;
    MODULES = yes;
    STAGING = no;
    AUXDISPLAY = no;
    ACCESSIBILITY = no;
    BT_HCIUART_BCSP = no;
    BT_HCIUART_H4 = no;
    BT_HCIUART_LL = no;
    BT_RFCOMM_TTY = no;
    DVB_DYNAMIC_MINORS = no;
    JOYSTICK_IFORCE_232 = no;
    JOYSTICK_IFORCE_USB = no;
    JOYSTICK_XPAD_FF = no;
    JOYSTICK_XPAD_LEDS = no;
    RC_DEVICES = no;
    HSA_AMD = no;
    SOUND = no;
  };
  extraConfig = {
    CC_OPTIMIZE_FOR_PERFORMANCE = yes;
    KERNEL_LZ4 = yes;
    KERNEL_XZ = no;
  };
  requiredConfig = {
    VIRTIO = yes;
    KVM_GUEST = yes;
    KVM_CLOCK = yes;
    VIRTIO_PCI = yes;
    SCSI_VIRTIO = yes;
    VIRTIO_NET = yes;
    PCI_MSI = yes;
  };
  hardenedConfig = {
    STRICT_DEVMEM = yes;
    DEVKMEM = no;
    DEFAULT_MMAP_MIN_ADDR = freeform "65536";
    DEBUG_RODATA = yes;
    DEBUG_SET_MODULE_RONX = yes;
    CC_STACKPROTECTOR = yes;
    COMPAT_VDSO = no;
    COMPAT_BRK = no;
    X86_PAE = yes;
    SYN_COOKIES = yes;
    SECURITY_YAMA = yes;
    SECURITY_YAMA_STACKED = yes;
  };
  hardeningSysctl = {
    net.ipv4.tcp_syncookies = 1;
    net.ipv4.conf.all.accept_source_route = 0;
    net.ipv4.conf.default.accept_source_route = 0;
    net.ipv4.conf.all.accept_redirects = 0;
    net.ipv4.conf.default.accept_redirects = 0;
    net.ipv4.conf.all.secure_redirects = 1;
    net.ipv4.conf.default.secure_redirects = 1;
    net.ipv4.ip_forward = 0;
    net.ipv4.conf.all.send_redirects = 0;
    net.ipv4.conf.default.send_redirects = 0;
    net.ipv4.conf.all.rp_filter = 1;
    net.ipv4.conf.default.rp_filter = 1;
    net.ipv4.icmp_echo_ignore_broadcasts = 1;
    net.ipv4.icmp_ignore_bogus_error_responses = 1;
    net.ipv4.conf.all.log_martians = 1;
    net.ipv4.conf.default.log_martians = 1;
    net.ipv4.tcp_rfc1337 = 1;
    kernel.randomize_va_space = 2;
    fs.protected_hardlinks = 1;
    fs.protected_symlinks = 1;
    kernel.kptr_restrict = 1;
    kernel.yama.ptrace_scope = 1;
    kernel.perf_event_paranoid = 2;
  };
in (linuxBuild.linux.override {
  inherit stdenv linux;
  extraMeta = {
    skip.ci = true;
  };
  extraConfig = [ requiredConfig extraConfig uncommonConfig hardenedConfig ];
  platform = stdenv.hostPlatform.platform // {
    #enableCommonConfig = false;
    kernelIgnoreConfigErrors = true;
    kernelAutoModules = false;
    kernelPreferBuiltin = true;
  };
}).kernel.overrideAttrs (old: {
  name = "linux-gce-${old.passthru.version}";
})
